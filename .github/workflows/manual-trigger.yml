name: Manual WeWork Message

# 手动触发工作流，支持选择不同的消息类型
on:
  workflow_dispatch:
    inputs:
      message_type:
        description: '选择消息类型'
        required: true
        default: 'daily'
        type: choice
        options:
        - daily
        - preview
        - custom
      custom_message:
        description: '自定义消息内容（仅当选择 custom 时使用）'
        required: false
        type: string
      webhook_test:
        description: '是否测试 webhook 连接'
        required: false
        default: false
        type: boolean

jobs:
  send-message:
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate inputs
        run: |
          echo "Message type: ${{ github.event.inputs.message_type }}"
          echo "Custom message: ${{ github.event.inputs.custom_message }}"
          echo "Webhook test: ${{ github.event.inputs.webhook_test }}"
          
          if [ "${{ github.event.inputs.message_type }}" = "custom" ] && [ -z "${{ github.event.inputs.custom_message }}" ]; then
            echo "❌ Custom message is required when message type is 'custom'"
            exit 1
          fi

      - name: Test webhook connection
        if: github.event.inputs.webhook_test == 'true'
        run: |
          echo "🔍 Testing webhook connection..."
          response=$(curl -s -w "\n%{http_code}" -X GET "${{ secrets.VERCEL_APP_URL }}/")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "✅ Webhook connection successful!"
          else
            echo "❌ Webhook connection failed"
            exit 1
          fi

      - name: Send daily message
        if: github.event.inputs.message_type == 'daily'
        run: |
          echo "📅 Sending daily message..."
          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.VERCEL_APP_URL }}/send-daily" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "✅ Daily message sent successfully!"
          else
            echo "❌ Failed to send daily message"
            exit 1
          fi

      - name: Send preview message
        if: github.event.inputs.message_type == 'preview'
        run: |
          echo "👀 Sending preview message..."
          response=$(curl -s -w "\n%{http_code}" -X GET "${{ secrets.VERCEL_APP_URL }}/preview-daily")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "HTTP Status: $http_code"
          echo "Preview content: $body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "✅ Preview generated successfully!"
          else
            echo "❌ Failed to generate preview"
            exit 1
          fi

      - name: Send custom message
        if: github.event.inputs.message_type == 'custom'
        run: |
          echo "✏️ Sending custom message..."
          
          # 构建自定义消息的 JSON 数据
          message_data=$(cat <<EOF
          {
            "message": "${{ github.event.inputs.custom_message }}"
          }
          EOF
          )
          
          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.VERCEL_APP_URL }}/send" \
            -H "Content-Type: application/json" \
            -d "$message_data")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "✅ Custom message sent successfully!"
          else
            echo "❌ Failed to send custom message"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "📊 Execution Summary:"
          echo "- Message Type: ${{ github.event.inputs.message_type }}"
          echo "- Webhook Test: ${{ github.event.inputs.webhook_test }}"
          if [ "${{ github.event.inputs.message_type }}" = "custom" ]; then
            echo "- Custom Message: ${{ github.event.inputs.custom_message }}"
          fi
          echo "- Execution Time: $(date)"
          echo "- Status: ${{ job.status }}"