name: Manual WeWork Message

# æ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼Œæ”¯æŒé€‰æ‹©ä¸åŒçš„æ¶ˆæ¯ç±»å‹
on:
  workflow_dispatch:
    inputs:
      message_type:
        description: 'é€‰æ‹©æ¶ˆæ¯ç±»å‹'
        required: true
        default: 'daily'
        type: choice
        options:
        - daily
        - preview
        - custom
      custom_message:
        description: 'è‡ªå®šä¹‰æ¶ˆæ¯å†…å®¹ï¼ˆä»…å½“é€‰æ‹© custom æ—¶ä½¿ç”¨ï¼‰'
        required: false
        type: string
      webhook_test:
        description: 'æ˜¯å¦æµ‹è¯• webhook è¿æ¥'
        required: false
        default: false
        type: boolean

jobs:
  send-message:
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate inputs
        run: |
          echo "Message type: ${{ github.event.inputs.message_type }}"
          echo "Custom message: ${{ github.event.inputs.custom_message }}"
          echo "Webhook test: ${{ github.event.inputs.webhook_test }}"
          
          if [ "${{ github.event.inputs.message_type }}" = "custom" ] && [ -z "${{ github.event.inputs.custom_message }}" ]; then
            echo "âŒ Custom message is required when message type is 'custom'"
            exit 1
          fi

      - name: Test webhook connection
        if: github.event.inputs.webhook_test == 'true'
        run: |
          echo "ğŸ” Testing webhook connection..."
          response=$(curl -s -w "\n%{http_code}" -X GET "${{ secrets.VERCEL_APP_URL }}/")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Webhook connection successful!"
          else
            echo "âŒ Webhook connection failed"
            exit 1
          fi

      - name: Send daily message
        if: github.event.inputs.message_type == 'daily'
        run: |
          echo "ğŸ“… Sending daily message..."
          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.VERCEL_APP_URL }}/send-daily" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Daily message sent successfully!"
          else
            echo "âŒ Failed to send daily message"
            exit 1
          fi

      - name: Send preview message
        if: github.event.inputs.message_type == 'preview'
        run: |
          echo "ğŸ‘€ Sending preview message..."
          response=$(curl -s -w "\n%{http_code}" -X GET "${{ secrets.VERCEL_APP_URL }}/preview-daily")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "HTTP Status: $http_code"
          echo "Preview content: $body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Preview generated successfully!"
          else
            echo "âŒ Failed to generate preview"
            exit 1
          fi

      - name: Send custom message
        if: github.event.inputs.message_type == 'custom'
        run: |
          echo "âœï¸ Sending custom message..."
          
          # æ„å»ºè‡ªå®šä¹‰æ¶ˆæ¯çš„ JSON æ•°æ®
          message_data=$(cat <<EOF
          {
            "message": "${{ github.event.inputs.custom_message }}"
          }
          EOF
          )
          
          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.VERCEL_APP_URL }}/send" \
            -H "Content-Type: application/json" \
            -d "$message_data")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Custom message sent successfully!"
          else
            echo "âŒ Failed to send custom message"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "ğŸ“Š Execution Summary:"
          echo "- Message Type: ${{ github.event.inputs.message_type }}"
          echo "- Webhook Test: ${{ github.event.inputs.webhook_test }}"
          if [ "${{ github.event.inputs.message_type }}" = "custom" ]; then
            echo "- Custom Message: ${{ github.event.inputs.custom_message }}"
          fi
          echo "- Execution Time: $(date)"
          echo "- Status: ${{ job.status }}"